import streamlit as st
import time
import re


# --- CONFIGURATION & STYLING ---
st.set_page_config(
    page_title="Claude Code CLI",
    layout="wide",
    initial_sidebar_state="expanded"
)


# ABSOLUTE BLACK THEME & CUSTOM SVG/ANIMATIONS
st.markdown("""
<style>
    @import url('https://fonts.cdnfonts.com/css/opendyslexic');
    @import url('https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css');


    /* Global Reset to Absolute Black */
    .stApp {
        background-color: #000000;
        font-family: 'OpenDyslexic', sans-serif !important;
        color: #e0e0e0;
    }
    
    /* Sidebar styling */
    section[data-testid="stSidebar"] {
        background-color: #0a0a0a;
        border-right: 1px solid #1a1a1a;
    }
    
    /* Input Fields */
    .stTextInput input {
        background-color: #0a0a0a !important;
        color: #e0e0e0 !important;
        border: 1px solid #1a1a1a !important;
        border-radius: 8px;
    }
    .stTextInput input:focus {
        border-color: #7c3aed !important; /* Purple Accent */
    }


    /* Status Line Container (Fixed Footer) */
    .status-line {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 42px;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid #1a1a1a;
        display: flex;
        align-items: center;
        padding: 0 1.5rem;
        z-index: 99999;
        font-family: 'OpenDyslexic', sans-serif;
        font-size: 0.85rem;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    }


    .status-segment {
        display: flex;
        align-items: center;
        margin-right: 1.5rem;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .status-segment:hover {
        background: rgba(255,255,255,0.08);
        box-shadow: 0 0 10px rgba(255,255,255,0.05);
        transform: translateY(-1px);
    }


    /* SVG Icon Alignment */
    .icon-svg {
        margin-right: 8px;
        vertical-align: middle;
        display: inline-block;
    }


    /* Custom Spinner Animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .custom-spinner {
        animation: spin 1s linear infinite;
        display: inline-block;
        transform-origin: center;
    }
    
    /* Terminal Cursor Animation */
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
    }
    .blinking-cursor::after {
        content: '▋';
        color: #c084fc;
        animation: blink 1s step-end infinite;
        margin-left: 2px;
        vertical-align: middle;
    }


    /* File Explorer Tree Styling */
    .file-tree-item {
        font-size: 0.8rem;
        padding: 4px 0;
        color: #888;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: color 0.2s;
    }
    .file-tree-item:hover {
        color: #e0e0e0;
    }
    .tree-indent {
        display: inline-block;
        width: 12px;
    }


    /* Custom Chat Message Styling */
    .stChatMessage {
        background-color: transparent !important;
        border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    
    /* Blockquote for 'Thought' */
    blockquote {
        border-left: 2px solid #333 !important;
        background: transparent !important;
        color: #888 !important;
        font-style: italic;
        font-size: 0.9rem;
    }


    /* Thinking Block (st.status) Customization */
    div[data-testid="stStatusWidget"] {
        background-color: #0a0a0a;
        border: 1px solid #222;
        color: #888;
    }


</style>
""", unsafe_allow_html=True)


# --- SVG ICON HELPER ---
def get_icon(name, color="#e0e0e0", size=16):
    """Returns raw SVG strings for high-fidelity icons."""
    icons = {
        "bot": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>',
        "folder": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>',
        "git": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>',
        "zap": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        "wrench": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
        "file": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>',
        "spinner": f'<svg class="custom-spinner" xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>',
        "play": f'<svg xmlns="http://www.w3.org/2000/svg" width="{size}" height="{size}" viewBox="0 0 24 24" fill="none" stroke="{color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
    }
    return icons.get(name, "")


# --- STATUS MANAGER ---
class StatuslineManager:
    """
    Parses CLI output to detect state changes for the UI.
    Manages configuration for colors and visibility.
    """
    def __init__(self):
        self.state = {
            "model": "Claude 3.5 Sonnet",
            "path": "~/projects/cli-wrapper",
            "git": "main",
            "status": "IDLE",
            "skills": ["Bash", "FileSystem"],
            "hooks": ["Pre-commit"]
        }
        # Default Preferences
        self.prefs = {
            "show_model": True, "color_model": "#c084fc",
            "show_path": True, "color_path": "#4ade80",
            "show_git": True, "color_git": "#facc15",
            "show_skills": True, "color_skills": "#60a5fa",
            "show_hooks": True, "color_hooks": "#f87171"
        }


# --- STATE INITIALIZATION ---
if "status_manager" not in st.session_state:
    st.session_state.status_manager = StatuslineManager()
if "history" not in st.session_state:
    st.session_state.history = []


# --- HELPER: FILE EXPLORER ---
def render_file_tree(structure, depth=0):
    indent = "&nbsp;" * (depth * 3)
    for item in structure:
        if item['type'] == 'folder':
            icon = get_icon('folder', "#e0e0e0", 12)
            st.markdown(f"<div class='file-tree-item'>{indent}<span class='icon-svg'>{icon}</span><span style='color:#e0e0e0; font-weight:bold;'>{item['name']}</span></div>", unsafe_allow_html=True)
            if 'children' in item:
                render_file_tree(item['children'], depth + 1)
        else:
            icon = get_icon('file', "#666", 12)
            st.markdown(f"<div class='file-tree-item'>{indent}<span class='icon-svg'>{icon}</span><span style='color:#888;'>{item['name']}</span></div>", unsafe_allow_html=True)


# Mock File Structure matching React
mock_files = [
    {'name': 'src', 'type': 'folder', 'children': [
        {'name': 'app.py', 'type': 'file'},
        {'name': 'utils.py', 'type': 'file'},
        {'name': 'config.json', 'type': 'file'}
    ]},
    {'name': 'tests', 'type': 'folder', 'children': [
        {'name': 'test_main.py', 'type': 'file'}
    ]},
    {'name': 'requirements.txt', 'type': 'file'},
    {'name': 'README.md', 'type': 'file'},
    {'name': '.gitignore', 'type': 'file'}
]


# --- SIDEBAR RENDER ---
def render_sidebar():
    sm = st.session_state.status_manager
    
    with st.sidebar:
        # Project Header
        st.caption("Active Project")
        icon_folder = get_icon("folder", "#c084fc", 18)
        st.markdown(f"""
        <div style="background:#121212; border:1px solid #222; border-radius:8px; padding:10px; display:flex; align-items:center; margin-bottom:1rem;">
            <div style="margin-right:10px;">{icon_folder}</div>
            <div style="overflow:hidden;">
                <div style="font-weight:bold; color:white; font-size:0.9rem;">cli-wrapper</div>
                <div style="color:#666; font-size:0.75rem; white-space:nowrap;">{sm.state['path']}</div>
            </div>
        </div>
        """, unsafe_allow_html=True)
        
        # Manual Command
        col_cmd, col_btn = st.columns([3, 1])
        with col_cmd:
            manual_cmd = st.text_input("Cmd", placeholder="ls -la", label_visibility="collapsed")
        with col_btn:
            if st.button("Run", use_container_width=True):
                 if manual_cmd:
                    with st.spinner(""):
                        time.sleep(0.5) 
                        st.session_state.history.append({"role": "user", "content": manual_cmd})
                        st.session_state.history.append({"role": "assistant", "content": f"Executed: {manual_cmd}", "type": "text"})
                        st.rerun()


        # Actions
        if st.button("Start CLI", type="primary", use_container_width=True):
            st.toast("Claude CLI Started")
        
        st.divider()
        
        # File Explorer
        with st.expander("Explorer", expanded=True):
            render_file_tree(mock_files)


        st.divider()


        # Statusline Config
        with st.expander("Statusline Config", expanded=False):
            st.caption("Widgets & Colors")
            
            # Agent Config
            c_a1, c_a2 = st.columns([3, 1])
            sm.prefs['show_model'] = c_a1.checkbox("Agent", value=sm.prefs['show_model'])
            sm.prefs['color_model'] = c_a2.color_picker("A_Col", sm.prefs['color_model'], label_visibility="collapsed")


            # Path Config
            c_p1, c_p2 = st.columns([3, 1])
            sm.prefs['show_path'] = c_p1.checkbox("Path", value=sm.prefs['show_path'])
            sm.prefs['color_path'] = c_p2.color_picker("P_Col", sm.prefs['color_path'], label_visibility="collapsed")


            # Git Config
            c_g1, c_g2 = st.columns([3, 1])
            sm.prefs['show_git'] = c_g1.checkbox("Git", value=sm.prefs['show_git'])
            sm.prefs['color_git'] = c_g2.color_picker("G_Col", sm.prefs['color_git'], label_visibility="collapsed")
            
            # Extras
            sm.prefs['show_skills'] = st.checkbox("Skills", value=sm.prefs['show_skills'])
            sm.prefs['show_hooks'] = st.checkbox("Hooks", value=sm.prefs['show_hooks'])


# --- STATUSLINE RENDER ---
def render_statusline():
    sm = st.session_state.status_manager
    s = sm.state
    p = sm.prefs
    
    segments = []
    
    if p['show_model']:
        icon = get_icon("bot", p["color_model"])
        segments.append(f'<div class="status-segment" style="color:{p["color_model"]}"><span class="icon-svg">{icon}</span> {s["model"]}</div>')
    if p['show_path']:
        icon = get_icon("folder", p["color_path"])
        segments.append(f'<div class="status-segment" style="color:{p["color_path"]}"><span class="icon-svg">{icon}</span> {s["path"]}</div>')
    if p['show_git']:
        icon = get_icon("git", p["color_git"])
        segments.append(f'<div class="status-segment" style="color:{p["color_git"]}"><span class="icon-svg">{icon}</span> {s["git"]}</div>')
    
    if p['show_skills'] and s["skills"]:
        skill_str = ", ".join(s["skills"])
        icon = get_icon("zap", p["color_skills"])
        segments.append(f'<div class="status-segment" style="color:{p["color_skills"]}"><span class="icon-svg" style="border-left:1px solid #333; padding-left:10px">{icon}</span> {skill_str}</div>')
    
    if p['show_hooks'] and s["hooks"]:
        hook_str = ", ".join(s["hooks"])
        icon = get_icon("wrench", p["color_hooks"])
        segments.append(f'<div class="status-segment" style="color:{p["color_hooks"]}"><span class="icon-svg">{icon}</span> {hook_str}</div>')


    segments_html = "".join(segments)
    
    # Status Indicator (Spinner or Dot)
    status_indicator = '<div style="width:8px; height:8px; background:#4ade80; border-radius:50%; display:inline-block;"></div>'
    status_color = "#4ade80"
    
    st.markdown(f"""
        <div class="status-line">
            {segments_html}
            <div style="flex-grow:1"></div>
            <div class="status-segment" style="color:#666">
                <span class="icon-svg">{status_indicator}</span>
                <span style="color:{status_color}; margin-left:4px">{s["status"]}</span>
            </div>
        </div>
    """, unsafe_allow_html=True)


# --- MOCK GENERATOR FOR STREAMING ---
def stream_data(text, delay=0.02):
    for word in text.split(" "):
        yield word + " "
        time.sleep(delay)


# --- MAIN LAYOUT ---
render_sidebar()


# Chat Container
chat_container = st.container()


# Render History
with chat_container:
    for msg in st.session_state.history:
        with st.chat_message(msg["role"]):
            if msg.get("type") == "thought":
                # Collapsible Thinking Block
                with st.status(msg.get("label", "Thinking Process"), expanded=msg.get("expanded", False)) as status:
                    st.write(msg["content"])
            elif msg.get("has_code"):
                # Simulating Code Block
                st.markdown(msg["content"])
                st.code(msg["code_content"], language="python")
            else:
                st.markdown(msg["content"])


# User Input
if prompt := st.chat_input("Message Claude..."):
    st.session_state.history.append({"role": "user", "content": prompt})
    
    # 1. Thinking Phase
    with st.chat_message("assistant"):
        with st.status("Analyzing Project Structure...", expanded=True) as status:
            st.write("Checking dependencies in requirements.txt...")
            time.sleep(1)
            st.write("Verifying git status...")
            time.sleep(0.5)
            status.update(label="Analysis Complete", state="complete", expanded=False)
        
        # Add thought to history
        st.session_state.history.append({
            "role": "assistant", 
            "type": "thought", 
            "content": "Checked dependencies and git status. Environment is stable.",
            "label": "Analysis Complete",
            "expanded": False
        })
        
        # 2. Text Response (Streamed)
        response_text = "I've analyzed the current environment. Streamlit is installed. Here is the implementation:"
        st.write_stream(stream_data(response_text))
        
        # 3. Code Response (Simulated Stream)
        code_text = """import streamlit as st


def main():
    st.title("Hello World")


if __name__ == "__main__":
    main()"""
        
        # Placeholder for blinking cursor effect
        code_placeholder = st.empty()
        displayed_code = ""
        for char in code_text:
            displayed_code += char
            # Update code block with blinking cursor appended
            code_placeholder.markdown(f'''```python
{displayed_code}<span class="blinking-cursor"></span>
```''', unsafe_allow_html=True)
            time.sleep(0.01)
            
        # Finalize code block
        code_placeholder.code(code_text, language="python")


        # Save to history
        st.session_state.history.append({
            "role": "assistant",
            "content": response_text,
            "has_code": True,
            "code_content": code_text
        })


render_statusline()