services:
  # ============================================================
  # 1. TRAEFIK - The Invisible Router
  # ============================================================
  reverse-proxy:
    image: traefik:v3.6.5
    command:
      - "--api.insecure=true"                    # Dashboard at :8080
      - "--providers.docker=true"                # Auto-discover containers
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"       # Main entry point
      - "8080:8080"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - legal-network

  # ============================================================
  # 2. REACT FRONTEND - Legal Workbench SPA
  # ============================================================
  frontend-react:
    build: ./frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.react.rule=PathPrefix(`/`)"
      - "traefik.http.routers.react.entrypoints=web"
      - "traefik.http.routers.react.priority=1"    # Catch-all (lowest priority)
      - "traefik.http.services.react.loadbalancer.server.port=3000"
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
      - api-doc-assembler

  # ============================================================
  # 3. STJ SERVICE - Jurisprudence API
  # ============================================================
  api-stj:
    build:
      context: .
      dockerfile: docker/services/stj-api/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stj.rule=PathPrefix(`/api/stj`)"
      - "traefik.http.routers.stj.entrypoints=web"
      - "traefik.http.routers.stj.priority=10"   # Higher priority than hub
      - "traefik.http.middlewares.stj-strip.stripprefix.prefixes=/api/stj"
      - "traefik.http.routers.stj.middlewares=stj-strip"
      - "traefik.http.services.stj.loadbalancer.server.port=8000"
    volumes:
      - shared-data:/data
      - stj-db:/app/db                           # Persistent DuckDB
    environment:
      - DATA_PATH=/data
      - DB_PATH=/app/db/stj.duckdb
    networks:
      - legal-network

  # ============================================================
  # 4. TEXT EXTRACTOR SERVICE - PDF Processing
  # ============================================================
  api-text-extractor:
    build: ./docker/services/text-extractor
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.text.rule=PathPrefix(`/api/text`)"
      - "traefik.http.routers.text.entrypoints=web"
      - "traefik.http.routers.text.priority=10"
      - "traefik.http.middlewares.text-strip.stripprefix.prefixes=/api/text"
      - "traefik.http.routers.text.middlewares=text-strip"
      - "traefik.http.services.text.loadbalancer.server.port=8001"
    volumes:
      - shared-data:/data
      - text-extractor-cache:/app/cache
    environment:
      - DATA_PATH=/data
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - MARKER_CACHE_DIR=/app/cache
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-2}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS:-600}
    networks:
      - legal-network
    depends_on:
      - redis

  # ============================================================
  # 5. DOC ASSEMBLER SERVICE - Document Generation
  # ============================================================
  api-doc-assembler:
    build:
      context: .
      dockerfile: docker/services/doc-assembler/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.doc.rule=PathPrefix(`/api/doc`)"
      - "traefik.http.routers.doc.entrypoints=web"
      - "traefik.http.routers.doc.priority=10"
      - "traefik.http.middlewares.doc-strip.stripprefix.prefixes=/api/doc"
      - "traefik.http.routers.doc.middlewares=doc-strip"
      - "traefik.http.services.doc.loadbalancer.server.port=8002"
    volumes:
      - shared-data:/data
      - templates:/app/templates
    environment:
      - DATA_PATH=/data
      - TEMPLATES_PATH=/app/templates
    networks:
      - legal-network

  # ============================================================
  # 6. TRELLO MCP SERVICE - Task Integration
  # ============================================================
  api-trello:
    build:
      context: .
      dockerfile: docker/services/trello-mcp/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.trello.rule=PathPrefix(`/api/trello`)"
      - "traefik.http.routers.trello.entrypoints=web"
      - "traefik.http.routers.trello.priority=10"
      - "traefik.http.middlewares.trello-strip.stripprefix.prefixes=/api/trello"
      - "traefik.http.routers.trello.middlewares=trello-strip"
      - "traefik.http.services.trello.loadbalancer.server.port=8004"
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_API_TOKEN=${TRELLO_API_TOKEN}
    networks:
      - legal-network

  # ============================================================
  # 7. LEDES CONVERTER - DOCX to LEDES Format
  # ============================================================
  api-ledes-converter:
    build: ./docker/services/ledes-converter
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ledes.rule=PathPrefix(`/api/ledes`)"
      - "traefik.http.routers.ledes.entrypoints=web"
      - "traefik.http.routers.ledes.priority=10"
      - "traefik.http.middlewares.ledes-strip.stripprefix.prefixes=/api/ledes"
      - "traefik.http.routers.ledes.middlewares=ledes-strip"
      - "traefik.http.services.ledes.loadbalancer.server.port=8003"
    volumes:
      - shared-data:/data
    environment:
      - DATA_PATH=/data
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 8. CCUI WEBSOCKET - Chat Backend for Claude Code UI
  # ============================================================
  api-ccui-ws:
    build: ./docker/services/ccui-ws
    labels:
      - "traefik.enable=true"
      # WebSocket route
      - "traefik.http.routers.ccui-ws.rule=PathPrefix(`/ws`)"
      - "traefik.http.routers.ccui-ws.entrypoints=web"
      - "traefik.http.routers.ccui-ws.priority=20"
      # Chat API route
      - "traefik.http.routers.ccui-chat.rule=PathPrefix(`/api/chat`)"
      - "traefik.http.routers.ccui-chat.entrypoints=web"
      - "traefik.http.routers.ccui-chat.priority=15"
      - "traefik.http.services.ccui-ws.loadbalancer.server.port=8005"
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 9. REDIS - Message Broker for Celery
  # ============================================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================
  # 10. PROMETHEUS - Metrics Collection
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    networks:
      - legal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 11. GRAFANA - Metrics Visualization
  # ============================================================
  grafana:
    image: grafana/grafana:10.2.0
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
    ports:
      - "3001:3000"
    networks:
      - legal-network
    depends_on:
      - prometheus
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================
# VOLUMES - Persistent Storage
# ============================================================
volumes:
  shared-data:           # Files shared between frontend and backends
  stj-db:                # DuckDB persistence for STJ
  templates:             # Document templates
  text-extractor-cache:  # Marker cache for PDF processing
  ledes-data:            # Persistent storage for LEDES converter
  redis-data:            # Redis persistence
  prometheus-data:       # Prometheus time-series data
  grafana-data:          # Grafana dashboards and settings

# ============================================================
# NETWORKS
# ============================================================
networks:
  legal-network:
    driver: bridge
