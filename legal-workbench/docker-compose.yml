services:
  # ============================================================
  # 1. TRAEFIK - The Invisible Router
  # ============================================================
  reverse-proxy:
    image: traefik:v3.6.5
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Redirect HTTP -> HTTPS
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=pedro@lexvector.com.br"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # File provider for external services
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik:/etc/traefik/dynamic:ro
      - ./docker/traefik/letsencrypt:/letsencrypt
      - ./docker/traefik/.htpasswd:/etc/traefik/.htpasswd:ro
    networks:
      - legal-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.auth.basicauth.usersfile=/etc/traefik/.htpasswd"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 2. REACT FRONTEND - Legal Workbench SPA
  # ============================================================
  frontend-react:
    build: ./frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.react.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/`)"
      - "traefik.http.routers.react.entrypoints=websecure"
      - "traefik.http.routers.react.tls=true"
      - "traefik.http.routers.react.tls.certresolver=letsencrypt"
      - "traefik.http.routers.react.priority=1"
      - "traefik.http.routers.react.middlewares=auth"
      - "traefik.http.services.react.loadbalancer.server.port=3000"
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
      - api-doc-assembler
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 3. STJ SERVICE - Jurisprudence API
  # ============================================================
  api-stj:
    build:
      context: .
      dockerfile: docker/services/stj-api/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stj.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/stj`)"
      - "traefik.http.routers.stj.entrypoints=websecure"
      - "traefik.http.routers.stj.tls=true"
      - "traefik.http.routers.stj.tls.certresolver=letsencrypt"
      - "traefik.http.routers.stj.priority=10"
      - "traefik.http.middlewares.stj-strip.stripprefix.prefixes=/api/stj"
      - "traefik.http.routers.stj.middlewares=stj-strip"
      - "traefik.http.services.stj.loadbalancer.server.port=8000"
    volumes:
      - shared-data:/data
      - /data/stj:/data/stj                      # Block Volume (200GB) for STJ data
    environment:
      - DATA_PATH=/data
      - DB_PATH=/data/stj/db/stj.duckdb          # DuckDB on Block Volume
      - ACORDAOS_PATH=/data/stj/acordaos         # PDFs on Block Volume
      - LOG_LEVEL=INFO
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
    networks:
      - legal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================
  # 4. TEXT EXTRACTOR SERVICE - PDF Processing
  # ============================================================
  api-text-extractor:
    build:
      context: .
      dockerfile: docker/services/text-extractor/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.text.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/text`)"
      - "traefik.http.routers.text.entrypoints=websecure"
      - "traefik.http.routers.text.tls=true"
      - "traefik.http.routers.text.tls.certresolver=letsencrypt"
      - "traefik.http.routers.text.priority=10"
      - "traefik.http.middlewares.text-strip.stripprefix.prefixes=/api/text"
      - "traefik.http.middlewares.text-buffering.buffering.maxRequestBodyBytes=104857600"
      - "traefik.http.routers.text.middlewares=text-strip,text-buffering"
      - "traefik.http.services.text.loadbalancer.server.port=8001"
    volumes:
      - shared-data:/data
      - text-extractor-cache:/app/cache
    environment:
      - DATA_PATH=/data
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - MARKER_CACHE_DIR=/app/cache
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-2}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS:-2100}
      - MARKER_TIMEOUT=${MARKER_TIMEOUT:-1800}
      - LOG_LEVEL=INFO
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      # Surya/Marker CPU optimization (ARM VM without GPU)
      - TORCH_DEVICE=cpu
      - DETECTOR_BATCH_SIZE=${DETECTOR_BATCH_SIZE:-4}
      - RECOGNITION_BATCH_SIZE=${RECOGNITION_BATCH_SIZE:-8}
      # Modal GPU serverless (optional - set MODAL_ENABLED=true to use)
      - MODAL_ENABLED=${MODAL_ENABLED:-false}
      - MODAL_TOKEN_ID=${MODAL_TOKEN_ID:-}
      - MODAL_TOKEN_SECRET=${MODAL_TOKEN_SECRET:-}
    networks:
      - legal-network
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================
  # 5. DOC ASSEMBLER SERVICE - Document Generation
  # ============================================================
  api-doc-assembler:
    build:
      context: .
      dockerfile: docker/services/doc-assembler/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.doc.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/doc`)"
      - "traefik.http.routers.doc.entrypoints=websecure"
      - "traefik.http.routers.doc.tls=true"
      - "traefik.http.routers.doc.tls.certresolver=letsencrypt"
      - "traefik.http.routers.doc.priority=10"
      - "traefik.http.middlewares.doc-strip.stripprefix.prefixes=/api/doc"
      - "traefik.http.routers.doc.middlewares=doc-strip"
      - "traefik.http.services.doc.loadbalancer.server.port=8002"
    volumes:
      - shared-data:/data
      - templates:/app/custom-templates
    environment:
      - DATA_PATH=/data
      - TEMPLATES_PATH=/app/templates
      - CUSTOM_TEMPLATES_PATH=/app/custom-templates
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
    networks:
      - legal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 6. TRELLO MCP SERVICE - Task Integration
  # ============================================================
  api-trello:
    build:
      context: .
      dockerfile: docker/services/trello-mcp/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.trello.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/trello`)"
      - "traefik.http.routers.trello.entrypoints=websecure"
      - "traefik.http.routers.trello.tls=true"
      - "traefik.http.routers.trello.tls.certresolver=letsencrypt"
      - "traefik.http.routers.trello.priority=10"
      - "traefik.http.middlewares.trello-strip.stripprefix.prefixes=/api/trello"
      - "traefik.http.routers.trello.middlewares=trello-strip"
      - "traefik.http.services.trello.loadbalancer.server.port=8004"
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_API_TOKEN=${TRELLO_API_TOKEN}
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
    networks:
      - legal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8004/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # ============================================================
  # 7. LEDES CONVERTER - DOCX to LEDES Format
  # ============================================================
  api-ledes-converter:
    build:
      context: .
      dockerfile: docker/services/ledes-converter/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ledes.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/ledes`)"
      - "traefik.http.routers.ledes.entrypoints=websecure"
      - "traefik.http.routers.ledes.tls=true"
      - "traefik.http.routers.ledes.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ledes.priority=10"
      - "traefik.http.middlewares.ledes-strip.stripprefix.prefixes=/api/ledes"
      - "traefik.http.routers.ledes.middlewares=ledes-strip"
      - "traefik.http.services.ledes.loadbalancer.server.port=8003"
    volumes:
      - shared-data:/data
    environment:
      - DATA_PATH=/data
      - LOG_LEVEL=INFO
      - SENTRY_DSN=${SENTRY_DSN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 8. CCUI WebSocket - Claude Code UI Backend
  # ============================================================
  api-ccui-ws:
    build:
      context: .
      dockerfile: docker/services/ccui-ws/Dockerfile
    labels:
      - "traefik.enable=true"
      # Chat API endpoint
      - "traefik.http.routers.ccui-chat.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/api/chat`)"
      - "traefik.http.routers.ccui-chat.entrypoints=websecure"
      - "traefik.http.routers.ccui-chat.tls=true"
      - "traefik.http.routers.ccui-chat.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ccui-chat.priority=15"
      # WebSocket endpoint
      - "traefik.http.routers.ccui-ws.rule=Host(`legalworkbench.duckdns.org`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.ccui-ws.entrypoints=websecure"
      - "traefik.http.routers.ccui-ws.tls=true"
      - "traefik.http.routers.ccui-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ccui-ws.priority=20"
      - "traefik.http.services.ccui-ws.loadbalancer.server.port=8005"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - LOG_LEVEL=INFO
      - SENTRY_DSN=${SENTRY_DSN:-}
    networks:
      - legal-network
    depends_on:
      - reverse-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 9. REDIS - Message Broker for Celery
  # ============================================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================
  # 9. PROMETHEUS - Metrics Collection
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    networks:
      - legal-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================
  # 10. GRAFANA - Metrics Visualization
  # ============================================================
  grafana:
    image: grafana/grafana:10.2.0
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
    ports:
      - "3001:3000"
    networks:
      - legal-network
    depends_on:
      - prometheus
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================
# VOLUMES - Persistent Storage
# ============================================================
volumes:
  shared-data:           # Files shared between frontend and backends
  templates:             # Document templates
  text-extractor-cache:  # Marker cache for PDF processing
  ledes-data:            # Persistent storage for LEDES converter
  redis-data:            # Redis persistence
  prometheus-data:       # Prometheus time-series data
  grafana-data:          # Grafana dashboards and settings

# ============================================================
# NETWORKS
# ============================================================
networks:
  legal-network:
    driver: bridge
