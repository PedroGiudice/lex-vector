services:
  # ============================================================
  # 1. TRAEFIK - The Invisible Router
  # ============================================================
  reverse-proxy:
    image: traefik:v3.6.5
    command:
      - "--api.insecure=true"                    # Dashboard at :8080
      - "--providers.docker=true"                # Auto-discover containers
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"       # Main entry point
      - "8080:8080"   # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - legal-network

  # ============================================================
  # 2. FASTHTML HUB - The Frontend (SSR, HTMX)
  # ============================================================
  frontend-hub:
    build: ./hub
    environment:
      - DATA_PATH=/data
      - NO_PROXY=localhost,127.0.0.1,reverse-proxy,api-stj,api-text-extractor,api-doc-assembler,api-trello,redis,frontend-hub
      - no_proxy=localhost,127.0.0.1,reverse-proxy,api-stj,api-text-extractor,api-doc-assembler,api-trello,redis,frontend-hub
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - http_proxy=
      - https_proxy=
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hub.rule=PathPrefix(`/`)"
      - "traefik.http.routers.hub.entrypoints=web"
      - "traefik.http.routers.hub.priority=1"    # Lowest priority (catch-all)
      - "traefik.http.services.hub.loadbalancer.server.port=5001"
    volumes:
      - shared-data:/data                        # Shared with backends
    networks:
      - legal-network
    depends_on:
      - reverse-proxy

  # ============================================================
  # 3. STJ SERVICE - Jurisprudence API
  # ============================================================
  api-stj:
    build:
      context: .
      dockerfile: docker/services/stj-api/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stj.rule=PathPrefix(`/api/stj`)"
      - "traefik.http.routers.stj.entrypoints=web"
      - "traefik.http.routers.stj.priority=10"   # Higher priority than hub
      - "traefik.http.middlewares.stj-strip.stripprefix.prefixes=/api/stj"
      - "traefik.http.routers.stj.middlewares=stj-strip"
      - "traefik.http.services.stj.loadbalancer.server.port=8000"
    volumes:
      - shared-data:/data
      - stj-db:/app/db                           # Persistent DuckDB
    environment:
      - DATA_PATH=/data
      - DB_PATH=/app/db/stj.duckdb
    networks:
      - legal-network

  # ============================================================
  # 4. TEXT EXTRACTOR SERVICE - PDF Processing
  # ============================================================
  api-text-extractor:
    build: ./docker/services/text-extractor
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.text.rule=PathPrefix(`/api/text`)"
      - "traefik.http.routers.text.entrypoints=web"
      - "traefik.http.routers.text.priority=10"
      - "traefik.http.middlewares.text-strip.stripprefix.prefixes=/api/text"
      - "traefik.http.routers.text.middlewares=text-strip"
      - "traefik.http.services.text.loadbalancer.server.port=8001"
    volumes:
      - shared-data:/data
      - text-extractor-cache:/app/cache
    environment:
      - DATA_PATH=/data
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - MARKER_CACHE_DIR=/app/cache
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-2}
      - JOB_TIMEOUT_SECONDS=${JOB_TIMEOUT_SECONDS:-600}
    networks:
      - legal-network
    depends_on:
      - redis

  # ============================================================
  # 5. DOC ASSEMBLER SERVICE - Document Generation
  # ============================================================
  api-doc-assembler:
    build:
      context: .
      dockerfile: docker/services/doc-assembler/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.doc.rule=PathPrefix(`/api/doc`)"
      - "traefik.http.routers.doc.entrypoints=web"
      - "traefik.http.routers.doc.priority=10"
      - "traefik.http.middlewares.doc-strip.stripprefix.prefixes=/api/doc"
      - "traefik.http.routers.doc.middlewares=doc-strip"
      - "traefik.http.services.doc.loadbalancer.server.port=8002"
    volumes:
      - shared-data:/data
      - templates:/app/templates
    environment:
      - DATA_PATH=/data
      - TEMPLATES_PATH=/app/templates
    networks:
      - legal-network

  # ============================================================
  # 6. TRELLO MCP SERVICE - Task Integration
  # ============================================================
  api-trello:
    build:
      context: .
      dockerfile: docker/services/trello-mcp/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.trello.rule=PathPrefix(`/api/trello`)"
      - "traefik.http.routers.trello.entrypoints=web"
      - "traefik.http.routers.trello.priority=10"
      - "traefik.http.middlewares.trello-strip.stripprefix.prefixes=/api/trello"
      - "traefik.http.routers.trello.middlewares=trello-strip"
      - "traefik.http.services.trello.loadbalancer.server.port=8004"
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_API_TOKEN=${TRELLO_API_TOKEN}
    networks:
      - legal-network

  # ============================================================
  # 7. REDIS - Message Broker for Celery
  # ============================================================
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    networks:
      - legal-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

# ============================================================
# VOLUMES - Persistent Storage
# ============================================================
volumes:
  shared-data:           # Files shared between frontend and backends
  stj-db:                # DuckDB persistence for STJ
  templates:             # Document templates
  text-extractor-cache:  # Marker cache for PDF processing
  redis-data:            # Redis persistence

# ============================================================
# NETWORKS
# ============================================================
networks:
  legal-network:
    driver: bridge
