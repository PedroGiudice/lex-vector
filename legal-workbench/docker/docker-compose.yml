# version removed (obsolete in Compose V2)

# Legal Workbench - Docker Compose
# Target: 14GB RAM WSL, i5 12th gen

networks:
  legal-workbench-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  stj-duckdb-data:
  text-extractor-cache:
  app-data:
  redis-data:

services:
  # ===========================================
  # Frontend
  # ===========================================
  streamlit-hub:
    build:
      context: ./services/streamlit-hub
      dockerfile: Dockerfile
    container_name: lw-hub
    ports:
      - "8501:8501"
    environment:
      - TEXT_EXTRACTOR_URL=http://text-extractor:8001
      - DOC_ASSEMBLER_URL=http://doc-assembler:8002
      - STJ_API_URL=http://stj-api:8000
      - TRELLO_MCP_URL=http://trello-mcp:8004
      - DATA_PATH=/app/data
      - NO_PROXY=text-extractor,doc-assembler,stj-api,trello-mcp,redis,localhost,127.0.0.1
      - no_proxy=text-extractor,doc-assembler,stj-api,trello-mcp,redis,localhost,127.0.0.1
    volumes:
      - app-data:/app/data
      - ../:/app/legal-workbench:ro  # Mount source for development
    networks:
      - legal-workbench-net
    depends_on:
      text-extractor:
        condition: service_healthy
      doc-assembler:
        condition: service_healthy
      stj-api:
        condition: service_healthy
      trello-mcp:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; r = requests.get('http://127.0.0.1:8501/_stcore/health', timeout=5); exit(0 if r.status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===========================================
  # Backend Services
  # ===========================================

  text-extractor:
    build:
      context: ./services/text-extractor
      dockerfile: Dockerfile
    container_name: lw-text-extractor
    ports:
      - "8001:8001"
      - "5555:5555"  # Celery Flower
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MARKER_CACHE_DIR=/app/cache
      - MAX_CONCURRENT_JOBS=2
      - JOB_TIMEOUT_SECONDS=600
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # Marker directories (writable by appuser)
      - FONT_DIR=/app/cache/fonts
      - FONT_PATH=/app/cache/fonts/GoNotoCurrent-Regular.ttf
      - OUTPUT_DIR=/app/cache/output
      - DEBUG_DATA_FOLDER=/app/cache/debug
    volumes:
      - text-extractor-cache:/app/cache
      - app-data:/app/data
    networks:
      - legal-workbench-net
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '2'
        reservations:
          memory: 4G
          cpus: '1'
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://127.0.0.1:8001/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Marker model loading
    restart: unless-stopped

  doc-assembler:
    build:
      context: ..
      dockerfile: docker/services/doc-assembler/Dockerfile
    container_name: lw-doc-assembler
    ports:
      - "8002:8002"
    environment:
      - TEMPLATES_DIR=/app/templates
      - OUTPUT_DIR=/app/output
    volumes:
      - app-data:/app/data
      - ../ferramentas/legal-doc-assembler/templates:/app/templates:ro
    networks:
      - legal-workbench-net
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  stj-api:
    build:
      context: ..
      dockerfile: docker/services/stj-api/Dockerfile
    container_name: lw-stj-api
    ports:
      - "8003:8000"
    environment:
      - DUCKDB_PATH=/app/data/stj.duckdb
      - CACHE_TTL_HOURS=24
      - SYNC_INTERVAL_HOURS=6
    volumes:
      - stj-duckdb-data:/app/data
    networks:
      - legal-workbench-net
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://127.0.0.1:8000/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===========================================
  # FastHTML BFF (STJ PoC)
  # ===========================================

  fasthtml-stj:
    build:
      context: ..
      dockerfile: docker/services/fasthtml-stj/Dockerfile
    container_name: lw-fasthtml-stj
    ports:
      - "5001:5001"
    environment:
      - STJ_API_URL=http://stj-api:8000
      - DUCKDB_PATH=/app/data/stj.duckdb
      - LOG_LEVEL=info
    volumes:
      - stj-duckdb-data:/app/data
    networks:
      - legal-workbench-net
    depends_on:
      stj-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  trello-mcp:
    build:
      context: ..
      dockerfile: docker/services/trello-mcp/Dockerfile
    container_name: lw-trello-mcp
    ports:
      - "8004:8004"
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_API_TOKEN=${TRELLO_API_TOKEN}
      - RATE_LIMIT_PER_MINUTE=100
    networks:
      - legal-workbench-net
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1'
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://127.0.0.1:8004/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ===========================================
  # Infrastructure
  # ===========================================

  redis:
    image: redis:7-alpine
    container_name: lw-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - legal-workbench-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
